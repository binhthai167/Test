{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ki·ªÉm tra ƒë·∫ßu v√†o</title>
    <link rel="stylesheet" type="text/css" href="{% static 'polls/index.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="poll-container">
    <h1 class="poll-title">üìù Ki·ªÉm tra ƒë·∫ßu v√†o</h1>
    <div class="user-info-container">
        <form id="submitAns" method="post" action="{% url 'polls:submit_exam' exam_code.code %}">
            {% csrf_token %}
            <div class="question-block">
                <label for="username" class="question-text">üë§ Nh·∫≠p t√™n c·ªßa b·∫°n:</label>
                <input type="text" id="username" name="username" class="input-text" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" value="{{ request.session.username|default_if_none:'' }}"  required data-error="Vui l√≤ng nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n">
                <label for = "phone" class="question-text">üìû Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n:</label>
                <input type="text" id="phone" name="phone" class="input-text" placeholder="0123456789" value="{{ request.session.phone|default_if_none:'' }}" required data-error="Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n">
                
                <label for="email" class="question-text">üìß Nh·∫≠p email c·ªßa b·∫°n:</label>
                <input type="email" id="email" name="email" class="input-text" placeholder="email@domain.com" value="{{ request.session.email|default_if_none:'' }}" required data-error="Vui l√≤ng nh·∫≠p email c·ªßa b·∫°n">
                <label for="supplier_company" class="question-text">üè¢ Nh·∫≠p t√™n c√¥ng ty cung ·ª©ng: </label>
                <input type="text" id="supplier_company" name="supplier_company" class="input-text" placeholder="C√¥ng ty TNHH ABC" value="{{ request.session.supplier_company|default_if_none:'' }}" required data-error="Vui l√≤ng nh·∫≠p t√™n c√¥ng ty cung ·ª©ng c·ªßa b·∫°n">
                <label for="license_plate" class="question-text">üöó Nh·∫≠p bi·ªÉn s·ªë xe (n·∫øu c√≥):</label>
                <input type="text" id="license_plate" name="license_plate" class="input-text" placeholder="ABC-1234" value="{{ request.session.license_plate|default_if_none:'' }}" >
            </div>
            <br>
            
            {% for question in questions %}
            <div class="question-block">
                <p class="question-text">
                    <strong>{{ forloop.counter }}) {{ question.question_text }}</strong>
                </p>
                {% if question.question_type == 'TEXT' %}
                    <textarea name="question_{{ question.id }}" rows="4" class="input-textarea" placeholder="Vi·∫øt c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v√†o ƒë√¢y...">{{ text_answers|get_item:question.id|default_if_none:"" }}</textarea>
                {% else %}
                    <div class="choice-list">
                        {% for choice in question.choice_set.all %}
                            <label class="choice-label">
                                <input type="radio"
                                       name="question_{{ question.id }}"
                                       value="{{ choice.id }}"
                                       {% if selected_choices|get_item:question.id == choice.id|stringformat:"s" %}checked{% endif %}>
                                <span class="choice-text">{{ choice.label }}. {{ choice.choice_text }}</span>
                            </label>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            {% endfor %}
            <input type="hidden" name="exam_code" value="{{ exam_code.code }}">
            <button type="submit" class="submit-btn">N·ªôp b√†i</button>
        </form>
    </div>
</div>

<script>
    document.querySelectorAll("#submitAns input").forEach(input => {
    // Khi input kh√¥ng h·ª£p l·ªá
    input.addEventListener("invalid", function (event) {
        event.preventDefault(); // NgƒÉn th√¥ng b√°o m·∫∑c ƒë·ªãnh
        if (!input.validity.valid) {
            input.setCustomValidity(input.dataset.error); // L·∫•y th√¥ng b√°o t·ª´ data-error
        } else {
            input.setCustomValidity("");
        }
        input.reportValidity();
    });
    // Khi input h·ª£p l·ªá
        input.addEventListener("input", function () {
        input.setCustomValidity("");
    });
});

   
    // H√†m l·∫•y CSRF token t·ª´ cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        console.log("CSRF Token:", cookieValue); // Debug CSRF token
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // L∆∞u c√¢u tr·∫£ l·ªùi vƒÉn b·∫£n
    document.querySelectorAll('textarea.input-textarea').forEach(function(textarea) {
        textarea.addEventListener('input', function() {
            const questionId = this.name.replace('question_', '');
            const answerText = this.value;
            saveTextAnswer(questionId, answerText);
        });
        // Kh·ªüi t·∫°o: G·ª≠i l·∫°i c√¢u tr·∫£ l·ªùi ƒë√£ l∆∞u t·ª´ session (n·∫øu c√≥) khi t·∫£i trang
        // const questionId = textarea.name.replace('question_', '');
        // if (textarea.value) {
        //     saveTextAnswer(questionId, textarea.value);
        // }
    });

    // L∆∞u c√¢u tr·∫£ l·ªùi tr·∫Øc nghi·ªám
    document.querySelectorAll('input[type=radio]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const questionId = this.name.replace('question_', '');
            const choiceId = this.value;
            saveChoice(questionId, choiceId);
        });
    });

    // H√†m l∆∞u c√¢u tr·∫£ l·ªùi vƒÉn b·∫£n qua AJAX
    function saveTextAnswer(questionId, answerText) {
        console.log("Saving text answer for question:", questionId, "Answer:", answerText);
        fetch("{% url 'polls:save_text_answer' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "question_id=" + encodeURIComponent(questionId) +
                  "&answer_text=" + encodeURIComponent(answerText)
        })
        .then(response => {
            console.log("Save text response status:", response.status);
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                console.log("Text answer saved successfully:", data);
                // L∆∞u v√†o localStorage nh∆∞ d·ª± ph√≤ng
            } else {
                console.error("Error saving text answer:", data.message);
                alert("L·ªói khi l∆∞u c√¢u tr·∫£ l·ªùi vƒÉn b·∫£n: " + data.message);
                localStorage.setItem('text_answer_' + questionId, answerText);
            }
        })
        .catch(error => {
            console.error("Error in saveTextAnswer:", error);
            localStorage.setItem('text_answer_' + questionId, answerText);
        });
    }

    // H√†m l∆∞u c√¢u tr·∫£ l·ªùi tr·∫Øc nghi·ªám qua AJAX
    function saveChoice(questionId, choiceId) {
        console.log("Saving choice for question:", questionId, "Choice:", choiceId);
        fetch("{% url 'polls:save_choice' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "question_id=" + encodeURIComponent(questionId) +
                  "&choice_id=" + encodeURIComponent(choiceId)
        })
        .then(response => {
            console.log("Save choice response status:", response.status);
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                console.log("Choice saved successfully:", data);
            } else {
                console.error("Error saving choice:", data.message);
                alert("L·ªói khi l∆∞u c√¢u tr·∫£ l·ªùi tr·∫Øc nghi·ªám: " + data.message);
            }
        })
        .catch(error => {
            console.error("Error in saveChoice:", error);
            alert("L·ªói k·∫øt n·ªëi khi l∆∞u c√¢u tr·∫£ l·ªùi tr·∫Øc nghi·ªám.");
        });
    }

    // X·ª≠ l√Ω redirect khi ƒë√£ ho√†n th√†nh b√†i thi
    const examCompletedStr = "{{ exam_completed|default_if_none:'false' }}";
    const examCompleted = examCompletedStr.toLowerCase() === "true";

    if (examCompleted) {
        window.location.replace("{% url 'polls:result' exam_code.code %}");
    }

    // X·ª≠ l√Ω khi trang ƒë∆∞·ª£c load t·ª´ b·ªô nh·ªõ cache c·ªßa tr√¨nh duy·ªát
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            window.location.replace("{% url 'polls:result' exam_code.code %}");
        }
    });

    // L∆∞u c√¢u tr·∫£ l·ªùi tr∆∞·ªõc khi trang ƒë∆∞·ª£c t·∫£i l·∫°i ho·∫∑c ƒë√≥ng
    window.addEventListener('beforeunload', function(event) {
        document.querySelectorAll('textarea.input-textarea').forEach(function(textarea) {
            const questionId = textarea.name.replace('question_', '');
            const answerText = textarea.value;
            if (answerText) {
                console.log("Before unload: Saving text answer for question:", questionId);
                saveTextAnswer(questionId, answerText);
            }
        });
        document.querySelectorAll('input[type=radio]:checked').forEach(function(radio) {
            const questionId = radio.name.replace('question_', '');
            const choiceId = radio.value;
            console.log("Before unload: Saving choice for question:", questionId);
            saveChoice(questionId, choiceId);
        });
    });

    // T·ª± ƒë·ªông l∆∞u c√¢u tr·∫£ l·ªùi m·ªói 5 gi√¢y
    setInterval(function() {
        document.querySelectorAll('textarea.input-textarea').forEach(function(textarea) {
            const questionId = textarea.name.replace('question_', '');
            const answerText = textarea.value;
            if (answerText) {
                console.log("Periodic save: Saving text answer for question:", questionId);
                saveTextAnswer(questionId, answerText);
            }
        });
        document.querySelectorAll('input[type=radio]:checked').forEach(function(radio) {
            const questionId = radio.name.replace('question_', '');
            const choiceId = radio.value;
            console.log("Periodic save: Saving choice for question:", questionId);
            saveChoice(questionId, choiceId);
        });
    }, 5000); // L∆∞u m·ªói 5 gi√¢y

    // Kh√¥i ph·ª•c c√¢u tr·∫£ l·ªùi t·ª´ localStorage khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('textarea.input-textarea').forEach(function(textarea) {
            const questionId = textarea.name.replace('question_', '');
            const savedAnswer = localStorage.getItem('text_answer_' + questionId);
            if (savedAnswer && !textarea.value) {
                console.log("Restoring text answer from localStorage for question:", questionId);
                textarea.value = savedAnswer;
                saveTextAnswer(questionId, savedAnswer); // G·ª≠i l·∫°i l√™n server
            }
        });
    });
</script>
</body>
</html>